<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reparto Chuli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 80vh; width: 100%; }
    #controls { padding: 10px; background: #f5f5f5; }
    input, button { padding: 8px; margin: 5px 0; width: 100%; }
    ul { list-style: none; padding: 0; }
    li { margin: 3px 0; }
  </style>
</head>
<body>

  <div id="controls">
    <h2>ðŸšš Reparto Chuli</h2>
    <input type="text" id="address" placeholder="Escribe una direcciÃ³n">
    <button onclick="addAddress()">Agregar destino</button>
    <button onclick="optimizeRoute()">Optimizar ruta</button>
    <ul id="destinations"></ul>
    <p id="stats"></p>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // API Keys
    const GOOGLE_MAPS_API_KEY = "AIzaSyDzXI4BChN3SN5geF3BNDZl8uOCyDhaw20";
    const ORS_API_KEY = "5b3ce3597851110001cf624857f0b7f1c9f44f14a4f9ac9a6b83f4c0"; // tu key de ORS

    // Inicializar mapa
    const map = L.map('map').setView([-38.0055, -57.5426], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let destinations = [];
    let markers = [];
    let routeLayer = null;

    async function addAddress() {
      const address = document.getElementById("address").value;
      if (!address) return;

      const response = await fetch(
        `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${GOOGLE_MAPS_API_KEY}`
      );
      const data = await response.json();

      if (data.status === "OK") {
        const location = data.results[0].geometry.location;
        destinations.push({ address, lat: location.lat, lng: location.lng });

        const marker = L.marker([location.lat, location.lng]).addTo(map)
          .bindPopup(address)
          .openPopup();
        markers.push(marker);

        const li = document.createElement("li");
        li.textContent = address;
        document.getElementById("destinations").appendChild(li);

        map.setView([location.lat, location.lng], 14);
        document.getElementById("address").value = "";
      } else {
        alert("No se encontrÃ³ la direcciÃ³n");
      }
    }

    async function optimizeRoute() {
      if (destinations.length < 2) {
        alert("Agrega al menos dos destinos");
        return;
      }

      const coordinates = destinations.map(d => [d.lng, d.lat]);

      const body = {
        coordinates,
        options: { round_trip: false }
      };

      const response = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
        method: "POST",
        headers: {
          "Authorization": ORS_API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      const data = await response.json();

      if (routeLayer) map.removeLayer(routeLayer);
      routeLayer = L.geoJSON(data, { style: { color: "blue", weight: 4 } }).addTo(map);

      const summary = data.features[0].properties.summary;
      document.getElementById("stats").textContent =
        `Distancia total: ${(summary.distance/1000).toFixed(2)} km | Tiempo estimado: ${(summary.duration/60).toFixed(0)} min`;

      const bounds = routeLayer.getBounds();
      map.fitBounds(bounds);
    }
  </script>

</body>
</html>
